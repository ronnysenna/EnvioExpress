datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Multi-tenant models
model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  domain    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Settings and configuration
  settings Json?

  // Relationships
  users             TenantUser[]
  contacts          Contact[]
  groups            Group[]
  images            Image[]
  campaigns         Campaign[]
  subscription      Subscription?
  invitations       Invitation[]
  events            Event[]
  campaignAnalytics CampaignAnalytics[]
  usageMetrics      UsageMetrics[]

  @@map("tenants")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relationships
  tenants   TenantUser[]
  selection Selection?
  events    Event[]

  @@map("users")
}

model TenantUser {
  id       String     @id @default(cuid())
  tenantId String
  userId   String
  role     TenantRole @default(USER)
  joinedAt DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("tenant_users")
}

model Invitation {
  id        String     @id @default(cuid())
  email     String
  role      TenantRole @default(USER)
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  token     String     @unique
  expiresAt DateTime
  createdAt DateTime   @default(now())

  @@unique([email, tenantId])
  @@map("invitations")
}

enum TenantRole {
  OWNER
  ADMIN
  USER
  VIEWER
}

model Contact {
  id       String  @id @default(cuid())
  nome     String
  telefone String
  email    String?

  // Multi-tenant fields
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  groups      ContactGroup[]
  messageLogs MessageLog[]

  @@unique([tenantId, telefone])
  @@map("contacts")
}

model Group {
  id        String  @id @default(cuid())
  nome      String
  descricao String?

  // Multi-tenant fields
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  contacts  ContactGroup[]

  @@unique([tenantId, nome])
  @@map("groups")
}

model ContactGroup {
  id        String   @id @default(cuid())
  contactId String
  groupId   String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([contactId, groupId])
  @@map("contact_groups")
}

model Image {
  id       String @id @default(cuid())
  url      String
  filename String

  // Multi-tenant fields
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("images")
}

model Selection {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @unique
  selectedIds Json
  updatedAt   DateTime @updatedAt

  @@map("selections")
}

// Campaign and messaging models
model Campaign {
  id           String         @id @default(cuid())
  name         String
  message      String
  imageUrl     String?
  status       CampaignStatus @default(DRAFT)
  scheduledFor DateTime?

  // Multi-tenant fields
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messageLogs MessageLog[]

  @@map("campaigns")
}

model MessageLog {
  id            String        @id @default(cuid())
  campaignId    String?
  campaign      Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  contactId     String
  contact       Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  status        MessageStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failureReason String?

  @@map("message_logs")
}

// Subscription and billing models
model Plan {
  id            String       @id @default(cuid())
  name          String       @unique
  description   String?
  price         Int // Price in cents
  currency      String       @default("BRL")
  interval      PlanInterval
  features      Json // Array of features
  limits        Json // Usage limits
  stripePriceId String?      @unique
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String             @id @default(cuid())
  tenantId             String             @unique
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId               String
  plan                 Plan               @relation(fields: [planId], references: [id])
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@map("subscriptions")
}

// Usage tracking for billing
// Analytics and Events models
model Event {
  id         String   @id @default(cuid())
  name       String // event name (e.g., "message_sent", "contact_created")
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  properties Json? // event properties as JSON
  metadata   Json? // additional metadata
  createdAt  DateTime @default(now())

  // Indexes for performance
  @@index([tenantId, name, createdAt])
  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@map("events")
}

model CampaignAnalytics {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaignId     String // Reference to message sending campaign
  campaignName   String?
  totalSent      Int      @default(0)
  totalDelivered Int      @default(0)
  totalOpened    Int      @default(0)
  totalClicked   Int      @default(0)
  totalFailed    Int      @default(0)
  deliveryRate   Float    @default(0)
  openRate       Float    @default(0)
  clickRate      Float    @default(0)
  period         String // YYYY-MM-DD format
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([tenantId, campaignId, period])
  @@index([tenantId, period])
  @@map("campaign_analytics")
}

model UsageMetrics {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  period        String // YYYY-MM format
  contactsCount Int      @default(0)
  messagesCount Int      @default(0)
  groupsCount   Int      @default(0)
  imagesCount   Int      @default(0)
  usersCount    Int      @default(0)
  apiRequests   Int      @default(0)
  storageUsed   BigInt   @default(0) // in bytes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, period])
  @@index([tenantId, period])
  @@map("tenant_usage_metrics")
}

// Enums
enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  UNPAID
  INCOMPLETE
}
